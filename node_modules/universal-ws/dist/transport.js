"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bs58 = require('bs58');
const DELIMITER = '$';
var Type;
(function (Type) {
    Type[Type["Browser"] = 0] = "Browser";
    Type[Type["Node"] = 1] = "Node";
})(Type = exports.Type || (exports.Type = {}));
var ReadyState;
(function (ReadyState) {
    ReadyState[ReadyState["Connecting"] = 0] = "Connecting";
    ReadyState[ReadyState["Open"] = 1] = "Open";
    ReadyState[ReadyState["Closing"] = 2] = "Closing";
    ReadyState[ReadyState["Closed"] = 3] = "Closed";
})(ReadyState = exports.ReadyState || (exports.ReadyState = {}));
var StatusCode;
(function (StatusCode) {
    StatusCode[StatusCode["Normal_Closure"] = 1000] = "Normal_Closure";
    StatusCode[StatusCode["Going_Away"] = 1001] = "Going_Away";
    StatusCode[StatusCode["Protocol_Error"] = 1002] = "Protocol_Error";
    StatusCode[StatusCode["Unexpected_Data"] = 1003] = "Unexpected_Data";
    StatusCode[StatusCode["Reserved_For_Future"] = 1004] = "Reserved_For_Future";
    StatusCode[StatusCode["No_Status_Code_Present"] = 1005] = "No_Status_Code_Present";
    StatusCode[StatusCode["Invalid_Data"] = 1006] = "Invalid_Data";
    StatusCode[StatusCode["Message_Error"] = 1007] = "Message_Error";
    StatusCode[StatusCode["Message_Too_Large"] = 1008] = "Message_Too_Large";
    StatusCode[StatusCode["Unexpected_Error"] = 1011] = "Unexpected_Error";
})(StatusCode = exports.StatusCode || (exports.StatusCode = {}));
class UniversalWs {
    constructor(host, options) {
        // https://developer.mozilla.org/en-US/docs/Web/API/WebSocket
        if (typeof WebSocket !== 'undefined') {
            this.ws = options.parameters ? new WebSocket(host, [this.encodeParameters(options.parameters)]) : new WebSocket(host);
            return;
        }
        try {
            const ws = require('ws');
            if (ws) {
                this.ws = options.parameters ? new ws(host, [this.encodeParameters(options.parameters)], options.perMessageDeflateOptions) : new ws(host, options.perMessageDeflateOptions);
                return;
            }
        }
        catch (_a) {
            throw new Error('Cannot construct WebSocket! Your environment may not support web sockets. See: https://caniuse.com/#feat=websockets');
        }
    }
    encodeParameters(parameters) {
        return bs58.encode(Buffer.from(parameters.join(DELIMITER), 'utf8'));
    }
    on(eventName, callback) {
        if (!this.ws)
            return;
        if (isBrowser(this.ws)) {
            switch (eventName) {
                case 'open':
                    this.ws.addEventListener('open', (event) => callback(event));
                    break;
                case 'message':
                    this.ws.addEventListener('message', (event) => {
                        callback(event.data);
                    });
                    break;
                case 'close':
                    this.ws.addEventListener('close', (event) => callback({ code: event.code, reason: event.reason }));
                    break;
                case 'error':
                    this.ws.addEventListener('error', (event) => callback(event));
                    break;
                default:
                    throw (`Invalid event name ${eventName}`);
            }
        }
        else {
            switch (eventName) {
                case 'open':
                    this.ws.on('open', callback);
                    break;
                case 'message':
                    this.ws.on('message', (data) => callback(data));
                    break;
                case 'close':
                    this.ws.on('close', (code, reason) => callback({ code, reason }));
                    break;
                case 'error':
                    this.ws.on('error', (error) => callback(error));
                    break;
                default:
                    throw (`Invalid event name ${eventName}`);
            }
        }
    }
    send(message) {
        if (!this.ws)
            return;
        if (isBrowser(this.ws)) {
            this.ws.send(message);
        }
        else {
            this.ws.send(message);
        }
    }
    close(code = 1000, reason = '') {
        if (!this.ws)
            return;
        if (isBrowser(this.ws)) {
            if (this.ws.readyState === this.ws.OPEN)
                this.ws.close(code, reason);
        }
        else {
            this.ws.close(code, reason);
        }
    }
    getReadyState() {
        if (!this.ws)
            return;
        if (isBrowser(this.ws)) {
            return ReadyState[this.ws.readyState];
        }
        else {
            return ReadyState[this.ws.readyState];
        }
    }
}
exports.UniversalWs = UniversalWs;
function isBrowser(ws) {
    return typeof WebSocket !== 'undefined';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNwb3J0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3RyYW5zcG9ydC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM3QixNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUM7QUFFdEIsSUFBWSxJQUdYO0FBSEQsV0FBWSxJQUFJO0lBQ1oscUNBQU8sQ0FBQTtJQUNQLCtCQUFJLENBQUE7QUFDUixDQUFDLEVBSFcsSUFBSSxHQUFKLFlBQUksS0FBSixZQUFJLFFBR2Y7QUFFRCxJQUFZLFVBS1g7QUFMRCxXQUFZLFVBQVU7SUFDbEIsdURBQVUsQ0FBQTtJQUNWLDJDQUFJLENBQUE7SUFDSixpREFBTyxDQUFBO0lBQ1AsK0NBQU0sQ0FBQTtBQUNWLENBQUMsRUFMVyxVQUFVLEdBQVYsa0JBQVUsS0FBVixrQkFBVSxRQUtyQjtBQUVELElBQVksVUFXWDtBQVhELFdBQVksVUFBVTtJQUNsQixrRUFBcUIsQ0FBQTtJQUNyQiwwREFBVSxDQUFBO0lBQ1Ysa0VBQWMsQ0FBQTtJQUNkLG9FQUFlLENBQUE7SUFDZiw0RUFBbUIsQ0FBQTtJQUNuQixrRkFBc0IsQ0FBQTtJQUN0Qiw4REFBWSxDQUFBO0lBQ1osZ0VBQWEsQ0FBQTtJQUNiLHdFQUFpQixDQUFBO0lBQ2pCLHNFQUF1QixDQUFBO0FBQzNCLENBQUMsRUFYVyxVQUFVLEdBQVYsa0JBQVUsS0FBVixrQkFBVSxRQVdyQjtBQUVELE1BQWEsV0FBVztJQUdwQixZQUFZLElBQVksRUFBRSxPQUFrRTtRQUN4Riw2REFBNkQ7UUFDN0QsSUFBSSxPQUFPLFNBQVMsS0FBSyxXQUFXLEVBQUU7WUFDbEMsSUFBSSxDQUFDLEVBQUUsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLFVBQVUs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